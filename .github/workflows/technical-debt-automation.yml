name: Technical Debt Automation

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  schedule:
    # Run comprehensive debt analysis daily at 3 AM UTC
    - cron: '0 3 * * *'
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        default: 'scan'
        type: choice
        options:
        - scan
        - report
        - plan
        - dashboard

env:
  PYTHON_VERSION: '3.12'

jobs:
  debt-detection:
    name: Technical Debt Detection
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event_name == 'pull_request' || github.event.inputs.action == 'scan'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Full history for trend analysis

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Cache Python dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt', '**/pyproject.toml') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: Install uv
      uses: astral-sh/setup-uv@v3
      with:
        version: "latest"

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install psutil matplotlib PyGithub

    - name: Run Enhanced Technical Debt Detection
      run: |
        python scripts/enhanced_technical_debt_detector.py . --output json > debt_scan_results.json

    - name: Update Debt Database
      run: |
        python scripts/technical_debt_workflow_manager.py . create-workflows

    - name: Generate Metrics
      run: |
        python scripts/technical_debt_metrics_kpi.py . dashboard > dashboard_metrics.json

    - name: Check for Critical Issues
      run: |
        python scripts/technical_debt_workflow_manager.py . escalations > escalations.json

    - name: Comment PR with Debt Results
      if: github.event_name == 'pull_request'
      env:
        PR_NUMBER: ${{ github.event.number }}
        REPO_OWNER: ${{ github.repository_owner }}
        REPO_NAME: ${{ github.event.repository.name }}
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        echo "PR comment generation - results in debt_scan_results.json"
        cat debt_scan_results.json | head -20

    - name: Upload Debt Scan Results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: debt-scan-results
        path: |
          debt_scan_results.json
          dashboard_metrics.json
          escalations.json
        retention-days: 30

  dashboard-generation:
    name: Generate Debt Dashboard
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event.inputs.action == 'report' || github.event.inputs.action == 'dashboard'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install matplotlib

    - name: Generate Debt Dashboard
      run: |
        python scripts/debt_dashboard_generator.py . --output-dir debt_reports

    - name: Generate Metrics Report
      run: |
        python scripts/technical_debt_metrics_kpi.py . report 30 > metrics_report.json

    - name: Deploy Dashboard to GitHub Pages
      if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./debt_reports
        destination_dir: debt-dashboard

    - name: Upload Dashboard Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: debt-dashboard
        path: |
          debt_reports/
          metrics_report.json
        retention-days: 90

  quarterly-planning:
    name: Quarterly Sprint Planning
    runs-on: ubuntu-latest
    if: contains(github.event.schedule, '0 3 * * 1') || github.event.inputs.action == 'plan'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip

    - name: Determine Quarter and Year
      id: quarter
      run: |
        QUARTER="Q$(( ($(date +%m) - 1) / 3 + 1 ))"
        YEAR=$(date +%Y)
        echo "quarter=${QUARTER}" >> "$GITHUB_OUTPUT"
        echo "year=${YEAR}" >> "$GITHUB_OUTPUT"
        echo "{\"quarter\": \"${QUARTER}\", \"year\": ${YEAR}}" > quarter_info.json

    - name: Generate Quarterly Sprint Plan
      run: |
        python scripts/quarterly_debt_sprint_planner.py . --quarter ${{ steps.quarter.outputs.quarter }} --year ${{ steps.quarter.outputs.year }} --output-dir sprint_plans

    - name: Upload Sprint Planning Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: sprint-planning
        path: sprint_plans/
        retention-days: 180

  metrics-and-kpis:
    name: Update Metrics and KPIs
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event_name == 'schedule'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip

    - name: Calculate Current KPIs
      run: |
        python scripts/technical_debt_metrics_kpi.py . kpis > current_kpis.json

    - name: Store Metrics in Database
      run: |
        python scripts/technical_debt_metrics_kpi.py . record-metrics

    - name: Check KPI Thresholds
      run: |
        python scripts/technical_debt_metrics_kpi.py . check-thresholds

    - name: Create Alert on Critical KPIs
      if: failure()
      env:
        WORKFLOW_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
      run: |
        echo "Checking for critical KPIs..."
        if [ -f current_kpis.json ]; then
          cat current_kpis.json | head -20
          echo "Would create alert for critical KPIs if present"
        else
          echo "No KPI file found"
        fi

  integration-tests:
    name: Technical Debt Integration Tests
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event_name == 'pull_request'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pytest pytest-cov

    - name: Create test directories if needed
      run: |
        mkdir -p tests/technical_debt

    - name: Run Basic Technical Debt Tests
      run: |
        echo "Testing technical debt scripts..."
        failed=0
        for script in scripts/enhanced_technical_debt_detector.py scripts/debt_dashboard_generator.py scripts/technical_debt_metrics_kpi.py; do
          if [ -f "$script" ]; then
            echo "Testing $script..."
            python -c "import importlib.util; spec = importlib.util.spec_from_file_location('m', '$script'); m = importlib.util.module_from_spec(spec); spec.loader.exec_module(m)" && echo "✓ $script OK" || { echo "✗ $script failed"; failed=1; }
          else
            echo "⚠ $script not found"
          fi
        done
        [ $failed -eq 0 ] && echo "All tests passed" || exit 1

    - name: Upload Test Results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results
        path: |
          test-results.xml
          test-report.json
        retention-days: 30

  cleanup:
    name: Cleanup and Maintenance
    runs-on: ubuntu-latest
    if: contains(github.event.schedule, '0 2 * * 0')  # Weekly on Sunday

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip

    - name: Cleanup Old Debt Data
      run: |
        echo "Cleaning up old debt data..."
        if [ -d ".claude" ] && [ -f ".claude/debt_trends.json" ]; then
          # Keep only trends from the last year (365 days)
          cutoff=$(date -d "365 days ago" +%Y-%m-%d 2>/dev/null || date -v-365d +%Y-%m-%d)
          echo "Cutoff date: $cutoff"
          # Use jq if available, otherwise skip cleanup
          if command -v jq &> /dev/null; then
            jq --arg cutoff "$cutoff" '[.[] | select(.date >= $cutoff)]' .claude/debt_trends.json > .claude/debt_trends.json.tmp && mv .claude/debt_trends.json.tmp .claude/debt_trends.json
            echo "Trends cleaned"
          else
            echo "jq not available, skipping cleanup"
          fi
        fi
        echo "Cleanup completed"

    - name: Archive Old Reports
      run: |
        echo "Archiving old reports..."
        if [ -d "debt_reports" ]; then
          mkdir -p archived_reports
          # Archive reports older than 180 days
          archived=0
          find debt_reports -type f -mtime +180 -exec sh -c 'mv "$1" archived_reports/ && echo "Archived: $1"' _ {} \; 2>/dev/null || true
          archived=$(find archived_reports -type f 2>/dev/null | wc -l)
          echo "Archived $archived old reports"
        fi
        echo "Archive cleanup completed"
