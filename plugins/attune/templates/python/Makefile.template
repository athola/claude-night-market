# {{PROJECT_NAME}} Makefile
# Generated by attune plugin

# Configuration
PROJECT_NAME := {{PROJECT_NAME}}
PROJECT_MODULE := {{PROJECT_MODULE}}
PYTHON_VERSION := {{PYTHON_VERSION}}

# Paths
SRC_DIR := src
TEST_DIR := tests

# Commands
UV_CMD := uv
PYTHON_CMD := python3

# uv cache location
UV_CACHE_DIR ?= $(abspath ./.uv-cache)
export UV_CACHE_DIR

PRE_COMMIT_HOME ?= $(abspath ./.pre-commit-cache)
export PRE_COMMIT_HOME

# Colors for output
BOLD := \033[1m
GREEN := \033[32m
BLUE := \033[34m
YELLOW := \033[33m
RED := \033[31m
RESET := \033[0m

# Phony targets
.PHONY: help install lint format typecheck test test-coverage check-all clean

# Help target
help: ## Show this help message
	@echo "$(BOLD)$(PROJECT_NAME) - Development Makefile$(RESET)"
	@echo ""
	@echo "$(BLUE)Available commands:$(RESET)"
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | \
		sort | \
		awk 'BEGIN {FS = ":.*?## "}; {printf "$(GREEN)%-20s$(RESET) %s\n", $$1, $$2}'

# Dependency management
install: ## Install all dependencies
	@echo "$(BLUE)Installing dependencies...$(RESET)"
	@mkdir -p $(UV_CACHE_DIR)
	$(UV_CMD) sync --extra dev
	@echo "$(GREEN)[OK] Dependencies installed$(RESET)"

# Code quality
lint: ## Run linting checks
	@echo "$(BLUE)Running linting...$(RESET)"
	$(UV_CMD) run ruff check .

format: ## Format code
	@echo "$(BLUE)Formatting code...$(RESET)"
	$(UV_CMD) run ruff format .

typecheck: ## Run type checking
	@echo "$(BLUE)Running type checking...$(RESET)"
	$(UV_CMD) run mypy $(SRC_DIR)/

# Testing
test: ## Run tests
	@echo "$(BLUE)Running tests...$(RESET)"
	$(UV_CMD) run pytest

test-coverage: ## Run tests with coverage report
	@echo "$(BLUE)Running tests with coverage...$(RESET)"
	$(UV_CMD) run pytest --cov=$(SRC_DIR)/$(PROJECT_MODULE) --cov-report=term-missing

# Combined checks
check-all: install lint format typecheck test ## Run all checks

# Pre-commit
install-hooks: ## Install pre-commit hooks
	@echo "$(BLUE)Installing pre-commit hooks...$(RESET)"
	@mkdir -p $(PRE_COMMIT_HOME)
	$(UV_CMD) run pre-commit install
	@echo "$(GREEN)[OK] Pre-commit hooks installed$(RESET)"

run-hooks: ## Run pre-commit hooks on all files
	@echo "$(BLUE)Running pre-commit hooks...$(RESET)"
	$(UV_CMD) run pre-commit run --all-files

# Cleanup
clean: ## Clean generated files and caches
	@echo "$(BLUE)Cleaning generated files...$(RESET)"
	rm -rf .uv-cache
	rm -rf __pycache__
	rm -rf $(SRC_DIR)/**/__pycache__
	rm -rf .pytest_cache
	rm -rf .mypy_cache
	rm -rf .ruff_cache
	rm -rf htmlcov
	rm -rf .coverage
	find . -type d -name "*.egg-info" -exec rm -rf {} + 2>/dev/null || true
	find . -type f -name "*.pyc" -delete 2>/dev/null || true
	@echo "$(GREEN)[OK] Cleanup complete$(RESET)"

# Build and publish
build: ## Build distribution packages
	@echo "$(BLUE)Building distribution...$(RESET)"
	$(UV_CMD) build
	@echo "$(GREEN)[OK] Build complete$(RESET)"

publish-test: build ## Publish to Test PyPI
	@echo "$(BLUE)Publishing to Test PyPI...$(RESET)"
	$(UV_CMD) publish --index testpypi

publish: build ## Publish to PyPI
	@echo "$(BLUE)Publishing to PyPI...$(RESET)"
	$(UV_CMD) publish

# Development
dev-setup: install install-hooks ## Complete development environment setup
	@echo "$(GREEN)[OK] Development environment ready!$(RESET)"

# CI target
ci: check-all ## Run CI checks
	@echo "$(GREEN)[OK] All CI checks passed!$(RESET)"
